<beast version="2.0"
       namespace="beast.base.inference
                 :beast.base.inference.parameter
                 :beast.base.evolution.tree
                 :beast.base.evolution.alignment
                 :beast.base.evolution.operator
                 :feast.simulation
                 :bdmmprime.distribution
                 :bdmmprime.parameterization
                 :bdmmprime.mapping">


        <startTypePriorProbs id="startTypePriorProbs" spec="RealParameter" value="0.5 0.5"/>

        <typeTraitSet id="typeTraitSet" spec="TraitSet" traitname="type" taxa="@taxonSet">
            t1=0,t2=0,t3=1,t4=1,t5=0
        </typeTraitSet>

        <taxonset spec="TaxonSet" id="taxonSet">
            <taxon spec="Taxon" id="t1"/>
            <taxon spec="Taxon" id="t2"/>
            <taxon spec="Taxon" id="t3"/>
            <taxon spec="Taxon" id="t4"/>
            <taxon spec="Taxon" id="t5"/>
        </taxonset>

    <run id="mcmc" spec="MCMC" chainLength="100000" sampleFromPrior="false">
        <state id="state" spec="State" storeEvery="10">

        <stateNode spec="beast.base.evolution.tree.TreeParser" id="tree" taxonset="@taxonSet" IsLabelledNewick="true"
                   adjustTipHeights="false" newick="(t5:5.7,((t1:1,t2:2):1,(t3:3,t4:4):0.5):1.3):0.0;" offset="0"/>


        <parameter id="origin" spec="parameter.RealParameter" name="stateNode" lower="0">6.0</parameter>
        <parameter id="lambda" spec="parameter.RealParameter" name="stateNode" lower="0">0.75 1.5</parameter>
        <parameter id="mu" spec="parameter.RealParameter" name="stateNode">1.0 1.5</parameter>
        <parameter id="migrationRate" spec="parameter.RealParameter" name="stateNode" lower="0">0.5 0.5</parameter>
        <parameter id="psi" spec="parameter.RealParameter" name="stateNode" lower="0">0.1 0.1</parameter>
        <parameter id="r" spec="parameter.RealParameter" name="stateNode" lower="0">1.0 1.0</parameter>
        <parameter id="spikes" spec="parameter.RealParameter" name="stateNode" lower="0">1</parameter>
        <parameter id="spikeShape" spec="parameter.RealParameter" name="stateNode" lower="0.2" upper="10">0.2</parameter>


        </state>

        <distribution id="posterior" spec="CompoundDistribution">
            <distribution id="prior" spec="CompoundDistribution">
                <distribution id="bdmDistr" spec="bdmmprime.distribution.BirthDeathMigrationDistribution" conditionOnSurvival="true"
                          tree="@tree" storeIntegrationResults="true">
                    <parameterization id="parameterization" spec="CanonicalParameterization">
                        <processLength spec="RealParameter" value="6.0"/>
                        <typeSet id="typeSet" spec="TypeSet" typeTraitSet="@typeTraitSet"/>
                        <birthRate spec="SkylineVectorParameter" skylineValues="@lambda"/>
                        <deathRate spec="SkylineVectorParameter" skylineValues="@mu"/>
                        <migrationRate spec="SkylineMatrixParameter" skylineValues="@migrationRate"/>
                        <samplingRate spec="SkylineVectorParameter" skylineValues="@psi"/>
                        <removalProb spec="SkylineVectorParameter" skylineValues="@r"/>
                    </parameterization>
                    <startTypePriorProbs idref="startTypePriorProbs"/>
                    <typeTraitSet idref="typeTraitSet"/>
                </distribution>

                <prior id="BranchSpikePrior" name="distribution" spec="multitypespike.distribution.BranchSpikePrior"
                       spikes="@spikes" spikeShape="@spikeShape" tree="@tree" parameterization="@parameterization"
                       startTypePriorProbs="@startTypePriorProbs" bdmDistr="@bdmDistr">
                </prior>

            </distribution>
        </distribution>


        <operator id="spikes.scale" spec="kernel.BactrianScaleOperator" parameter="@spikes" scaleFactor="0.1" weight="1.0"/>

        <logger id="tracelog" spec="Logger" fileName="$(filebase).log" logEvery="1" model="@posterior" sort="smart">
            <log idref="spikes"/>
            <log id="nHiddenEvents" spec="multitypespike.logger.HiddenEventsLogger" branchSpikePrior="@BranchSpikePrior"/>
            <log id="expectedHiddenEvents" spec="multitypespike.logger.ExpectedHiddenEventsLogger" branchSpikePrior="@BranchSpikePrior"/>

            <log id="nHiddenEventsPerType" spec="multitypespike.logger.HiddenEventsLogger" branchSpikePrior="@BranchSpikePrior" logPerType="true"/>
            <log id="expectedHiddenEventsPerType" spec="multitypespike.logger.ExpectedHiddenEventsLogger" branchSpikePrior="@BranchSpikePrior" logPerType="true"/>
        </logger>


        <logger id="screenlog" spec="Logger" logEvery="1000">
            <log idref="nHiddenEvents"/>
        </logger>
    </run>
</beast>
